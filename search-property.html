<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/images/favicon_goldenrabbit_01.png" type="image/x-icon">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#e38000">
    <title>ë§¤ë¬¼ê²€ìƒ‰ - ê¸ˆí† ë¼ë¶€ë™ì‚°ì¤‘ê°œ</title>
    <!-- ìë™ ì—…ë°ì´íŠ¸ ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="/js/auto-update.js"></script>
</head>
<body>
    <!-- í—¤ë” ì˜ì—­ -->
    <header id="top">
        <div class="container header-content">
            <div class="logo">
                <img src="/images/logo_goldenrabbit.jpg" alt="ê¸ˆí† ë¼ë¶€ë™ì‚° ë¡œê³ ">
                <div>
                    <h1>ê¸ˆí† ë¼ë¶€ë™ì‚°ì¤‘ê°œ</h1>
                    <div class="logo-sub">Golden Rabbit Real Estate</div>
                </div>
            </div>
        </div>
    </header>

    <!-- ë§¤ë¬¼ê²€ìƒ‰ ì„¹ì…˜ -->
    <section id="property-search">
        <div class="container">
            <div class="section-title">
                <h2>ì¡°ê±´ ê²€ìƒ‰</h2>
                <p>ì›í•˜ëŠ” ì¡°ê±´ì„ ì…ë ¥í•˜ë©´<br>ì¡°ê±´ì— ë§ëŠ” ë§¤ë¬¼ì´ ì§€ë„ì— í‘œì‹œë©ë‹ˆë‹¤</p>
            </div>
            
            <div class="search-form" style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                <form id="mapSearchForm">
                    <div class="search-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        
                        <!-- ë§¤ê°€ ì¡°ê±´ -->
                        <div class="search-item">
                            <label>ë§¤ê°€</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="priceValue" placeholder="ë§Œì›" class="form-control" style="flex: 1;">
                                <select id="priceCondition" class="form-control" style="width: 80px;">
                                    <option value="all">ì „ì²´</option>
                                    <option value="above">ì´ìƒ</option>
                                    <option value="below">ì´í•˜</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- ì‹¤íˆ¬ìê¸ˆ ì¡°ê±´ -->
                        <div class="search-item">
                            <label>ì‹¤íˆ¬ìê¸ˆ</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="investmentValue" placeholder="ë§Œì›" class="form-control" style="flex: 1;">
                                <select id="investmentCondition" class="form-control" style="width: 80px;">
                                    <option value="all">ì „ì²´</option>
                                    <option value="above">ì´ìƒ</option>
                                    <option value="below">ì´í•˜</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- ìˆ˜ìµë¥  ì¡°ê±´ -->
                        <div class="search-item">
                            <label>ìˆ˜ìµë¥ </label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="yieldValue" placeholder="%" class="form-control" style="flex: 1;">
                                <select id="yieldCondition" class="form-control" style="width: 80px;">
                                    <option value="all">ì „ì²´</option>
                                    <option value="above">ì´ìƒ</option>
                                    <option value="below">ì´í•˜</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- í† ì§€ë©´ì  ì¡°ê±´ -->
                        <div class="search-item">
                            <label>í† ì§€ë©´ì </label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="areaValue" placeholder="ã¡" class="form-control" style="flex: 1;">
                                <select id="areaCondition" class="form-control" style="width: 80px;">
                                    <option value="all">ì „ì²´</option>
                                    <option value="above">ì´ìƒ</option>
                                    <option value="below">ì´í•˜</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- ì‚¬ìš©ìŠ¹ì¸ì¼ ì¡°ê±´ -->
                        <div class="search-item">
                            <label>ì‚¬ìš©ìŠ¹ì¸ì¼</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="date" id="approvalDate" class="form-control" style="flex: 1;">
                                <select id="approvalCondition" class="form-control" style="width: 80px;">
                                    <option value="all">ì „ì²´</option>
                                    <option value="before">ì´ì „</option>
                                    <option value="after">ì´í›„</option>
                                </select>
                            </div>
                        </div>
                        
                    </div>
                    
                    <div class="search-buttons" style="text-align: center; margin-top: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                        <button type="submit" class="btn search-button">ì¡°ê±´ì— ë§ëŠ” ë§¤ë¬¼ ê²€ìƒ‰í•˜ê¸°</button>
                        <button type="button" id="resetSearch" class="btn reset-button" style="background-color: #6c757d;">ê²€ìƒ‰ ì´ˆê¸°í™”</button>
                    </div>
                </form>
            </div>
            
            <!-- ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
            <div id="searchResults" style="margin-top: 20px; display: none;">
                <div id="searchStatus" style="background: #f0f0f0; padding: 10px; border-radius: 4px; text-align: center; margin-bottom: 20px;">
                    <strong id="searchStatusText">ì¡°ê±´ì— ë§ëŠ” ë§¤ë¬¼ì„ ê²€ìƒ‰ì¤‘ì…ë‹ˆë‹¤...</strong>
                </div>
                
                <!-- ê²€ìƒ‰ ê²°ê³¼ ì§€ë„ ì»¨í…Œì´ë„ˆ -->
                <div id="searchMapContainer" class="search-map-container" style="width: 100%; height: 500px; position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 3px 15px rgba(0,0,0,0.1);">
                    <div class="loading-message" style="text-align: center; padding: 150px 20px;">
                        ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- AI ë§¤ë¬¼ ê²€ìƒ‰ ì„¹ì…˜ -->
    <section id="ai-search">
        <div class="container">
            <div class="section-title">
                <h2>AI ë§ì¶¤ ë§¤ë¬¼ ê²€ìƒ‰</h2>
                <p>ì›í•˜ëŠ” ì¡°ê±´ì„ ì…ë ¥í•˜ì‹œë©´<br>ì¸ê³µì§€ëŠ¥ì´ ìµœì ì˜ ë§¤ë¬¼ì„ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤</p>
            </div>
            
            <div class="ai-search-container">
                <div class="ai-search-form">
                    <form id="aiSearchForm">
                        <div class="form-group">
                            <label for="ai_location">í¬ë§ ì§€ì—­</label>
                            <input type="text" id="ai_location" class="form-control" placeholder="ì˜ˆ: ì‚¬ë‹¹ë™, ì‹ ë¦¼ë™, ë™ì‘êµ¬ ë“±ë“±" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="priceRange">í¬ë§ ë§¤ë§¤ê°€</label>
                            <select id="priceRange" class="form-control" required>
                                <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
                                <option value="15ì–µ ì´í•˜">15ì–µ ì´í•˜</option>
                                <option value="15ì–µ-30ì–µ">15ì–µ-30ì–µ</option>
                                <option value="30ì–µ ì´ìƒ">30ì–µ ì´ìƒ</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="investment">ì‹¤íˆ¬ìê¸ˆ</label>
                            <select id="investment" class="form-control" required>
                                <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
                                <option value="10ì–µ ì´í•˜">10ì–µ ì´í•˜</option>
                                <option value="10ì–µ-20ì–µ">10ì–µ-20ì–µ</option>
                                <option value="20ì–µ ì´ìƒ">20ì–µ ì´ìƒ</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="expectedYield">í¬ë§ íˆ¬ììˆ˜ìµë¥ </label>
                            <select id="expectedYield" class="form-control" required>
                                <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
                                <option value="ìˆ˜ìµë¥  ë¬´ê´€">ìˆ˜ìµë¥  ë¬´ê´€</option>
                                <option value="3% ì´ìƒ">3% ì´ìƒ</option>
                                <option value="5% ì´ìƒ">5% ì´ìƒ</option>
                                <option value="7% ì´ìƒ">7% ì´ìƒ</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-block">AI ë§¤ë¬¼ ì¶”ì²œë°›ê¸°</button>
                    </form>
                </div>
                
                <div class="ai-search-results" id="aiSearchResults" style="display: none;">
                    <h3>ë§ì¶¤ ì¶”ì²œ ë§¤ë¬¼</h3>
                    <div class="ai-loading" id="aiLoading">
                        <div class="loading-spinner"></div>
                        <p>AIê°€ ìµœì ì˜ ë§¤ë¬¼ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</p>
                    </div>
                    <div id="aiRecommendations"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- ë§¤ë¬¼ ìƒì„¸ ëª¨ë‹¬ ì¶”ê°€ (ìƒë‹´ ëª¨ë‹¬ ìœ„ì— ì¶”ê°€) -->
    <div id="propertyDetailModal" class="modal-background" style="display: none;">
        <div class="modal-content" style="width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-close" onclick="closePropertyDetailModal()">&times;</div>
            <div class="modal-body">
                <div id="propertyDetailContainer"></div>
            </div>
        </div>
    </div>

    <!-- ìƒë‹´ ëª¨ë‹¬ ì¶”ê°€ -->
    <div id="consultModal" class="modal-background" style="display: none;">
        <div class="modal-content">
          <div class="modal-close" onclick="closeConsultModal()">&times;</div>
          <div class="modal-body">
            <h2 class="modal-title">ìƒë‹´ ë¬¸ì˜</h2>
            <div class="contact-form">
              <form id="consultForm">
                <div class="form-group">
                  <label for="propertyType">ë§¤ë¬¼ì¢…ë¥˜</label>
                  <select id="propertyType" name="propertyType" class="form-control" required>
                    <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
                    <option value="house">ë‹¨ë…/ë‹¤ê°€êµ¬</option>
                    <option value="mixed">ìƒê°€ì£¼íƒ</option>
                    <option value="commercial">ìƒì—…ìš©ê±´ë¬¼</option>
                    <option value="land">ì¬ê±´ì¶•/í† ì§€</option>
                    <option value="sell">ë§¤ë¬¼ì ‘ìˆ˜</option>
                  </select>
                </div>
      
                <div class="form-group">
                  <label for="phone">ì—°ë½ì²˜</label>
                  <input type="tel" id="phone" name="phone" class="form-control" placeholder="010-0000-0000" required>
                </div>
      
                <div class="form-group">
                  <label for="email">ì´ë©”ì¼ <span style="font-size: 12px; color: #888; font-weight: normal;">(ì„ íƒì‚¬í•­)</span></label>
                  <input type="email" id="email" name="email" class="form-control" placeholder="abc@abc.com">
                </div>
      
                <div class="form-group">
                  <label for="message">ë¬¸ì˜ì‚¬í•­</label>
                  <textarea id="message" name="message" class="form-control" placeholder="ê´€ì‹¬ì§€ì—­, í‰í˜•, í¬ë§ìˆ˜ìµë¥  ë“±ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”!" required></textarea>
                </div>
      
                <button type="button" id="submitConsult" class="btn btn-contact btn-block">ìƒë‹´ ì‹ ì²­í•˜ê¸°</button>
                <div id="formStatus" style="margin-top: 15px; text-align: center; display: none;"></div>
              </form>
            </div>
          </div>
        </div>
    </div>

    <!-- í‘¸í„° ì˜ì—­ -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-about">
                    <div class="footer-logo">
                        <img src="/images/logo_goldenrabbit.jpg" alt="ê¸ˆí† ë¼ë¶€ë™ì‚° ë¡œê³ " style="height: 40px; margin-right: 10px; vertical-align: middle;">
                        ê¸ˆí† ë¼ë¶€ë™ì‚°ì¤‘ê°œ
                    </div>
                    <div class="footer-description">
                        ì „ë¬¸ê°€ì™€ í•¨ê»˜í•˜ëŠ” ê¸ˆí† ë¼ë¶€ë™ì‚°ì¤‘ê°œì…ë‹ˆë‹¤.<br>
                        ìˆ˜ìµí˜• ê±´ë¬¼ ë§¤ë§¤, ì„ëŒ€ ì „ë¬¸ ë¶€ë™ì‚°ì…ë‹ˆë‹¤.
                    </div>
                    <div class="social-icons">
                        <a href="https://open.kakao.com/o/sW37rY9g" class="social-icon" target="_blank" title="ì¹´ì¹´ì˜¤í†¡ ì±„ë„">
                            <img src="/images/ì¹´ì¹´ì˜¤í†¡.png" alt="ì¹´ì¹´ì˜¤í†¡" style="width: 20px; height: 20px;">
                        </a>
                        <a href="https://www.disco.re/hvzt1qow?share" class="social-icon" target="_blank" title="ë””ìŠ¤ì½”">
                            <img src="/images/ë””ìŠ¤ì½”ë¡œê³ .png" alt="ë””ìŠ¤ì½”" style="width: 20px; height: 20px;">
                        </a>
                        <a href="https://blog.naver.com/goldenrabbit7377" class="social-icon" target="_blank" title="ë„¤ì´ë²„ ë¸”ë¡œê·¸">
                            <img src="/images/ë¸”ë¡œê·¸.png" alt="ë„¤ì´ë²„ ë¸”ë¡œê·¸" style="width: 20px; height: 20px;">
                        </a>
                        <a href="https://www.youtube.com/@goldenrabbit_realestate" class="social-icon" target="_blank" title="ìœ íŠœë¸Œ ì±„ë„">
                            <img src="/images/ìœ íŠœë¸Œ.png" alt="ìœ íŠœë¸Œ" style="width: 20px; height: 20px;">
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="copyright">
                &copy; 2024 ê¸ˆí† ë¼ë¶€ë™ì‚°ì¤‘ê°œ. All rights reserved. <br> ëŒ€í‘œ: ì „ì°½ì„± | ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 520-41-01170 <br> ì¤‘ê°œì‚¬ë¬´ì†Œë“±ë¡ë²ˆí˜¸: 11590-2024-00048
            </div>
        </div>
    </footer>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <div class="nav-icon">ğŸ </div>
            <div class="nav-text">í™ˆ</div>
        </a>
        <a href="introduction.html" class="nav-item">
            <div class="nav-icon">ğŸ‘‹</div>
            <div class="nav-text">íšŒì‚¬ì†Œê°œ</div>
        </a>
        <a href="map-property.html" class="nav-item">
            <div class="nav-icon">ğŸ—ºï¸</div>
            <div class="nav-text">ë§¤ë¬¼ì§€ë„</div>
        </a>
        <a href="recomm-property.html" class="nav-item">
            <div class="nav-icon">â­</div>
            <div class="nav-text">ì¶”ì²œë§¤ë¬¼</div>
        </a>
        <a href="search-property.html" class="nav-item active">
            <div class="nav-icon">ğŸ”</div>
            <div class="nav-text">ë§¤ë¬¼ê²€ìƒ‰</div>
        </a>
        <a href="inquiry.html" class="nav-item">
            <div class="nav-icon">ğŸ“</div>
            <div class="nav-text">ìƒë‹´ë¬¸ì˜</div>
        </a>
    </nav>

    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="/js/ai-property-search.js"></script>
    <script src="/js/inquiry-form.js"></script>
    <script src="/js/navigation.js"></script>

    <script>
        // ìƒë‹´ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
        function openConsultModal(address) {
            const consultModal = document.getElementById('consultModal');
            consultModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            const messageField = document.getElementById('message');
            if (messageField && address) {
                messageField.value = `${address}ì— ëŒ€í•´ ìƒë‹´ ë¬¸ì˜í•©ë‹ˆë‹¤.`;
            }
        }

        function closeConsultModal() {
            const consultModal = document.getElementById('consultModal');
            if (consultModal) {
                consultModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // ë§¤ë¬¼ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
        async function openPropertyDetailModal(recordId) {
            // ì½˜ì†” ë©”ì„¸ì§€ ë¹„í™œì„±í™” 
            // console.log('ë§¤ë¬¼ ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°:', recordId);
            
            try {
                const modal = document.getElementById('propertyDetailModal');
                const container = document.getElementById('propertyDetailContainer');
                
                if (!modal || !container) {
                    console.error('ë§¤ë¬¼ ìƒì„¸ ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
                container.innerHTML = `
                    <div style="text-align:center; padding:40px;">
                        <div style="margin-bottom:15px;">
                            <div class="loading-spinner" style="width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid #e38000; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto;"></div>
                        </div>
                        <div>ë§¤ë¬¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
                    </div>
                `;
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // APIì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(`/api/property-detail?id=${recordId}`);
                
                if (!response.ok) {
                    throw new Error('ë§¤ë¬¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const data = await response.json();
                
                if (data.error || !data.property) {
                    throw new Error(data.error || 'ë§¤ë¬¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // ë§¤ë¬¼ ì •ë³´ ë Œë”ë§
                const html = await renderPropertyDetail(data.property);
                container.innerHTML = html;
                
            } catch (error) {
                console.error('ë§¤ë¬¼ ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                const container = document.getElementById('propertyDetailContainer');
                if (container) {
                    container.innerHTML = `
                        <div style="color:red; text-align:center; padding:20px;">
                            <h3>ì˜¤ë¥˜ ë°œìƒ</h3>
                            <p>${error.message}</p>
                            <button onclick="closePropertyDetailModal()" class="btn btn-secondary" style="margin-top:10px;">ë‹«ê¸°</button>
                        </div>
                    `;
                }
            }
        }

        // openPropertyDetail í•¨ìˆ˜ (ë³„ì¹­ - ì—ëŸ¬ í•´ê²°ìš©)
        function openPropertyDetail(recordId) {
            // ì½˜ì†” ë©”ì„¸ì§€ ë¹„í™œì„±í™” 
            // console.log('openPropertyDetail í˜¸ì¶œë¨:', recordId);
            return openPropertyDetailModal(recordId);
        }

        // ë§¤ë¬¼ ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
        function closePropertyDetailModal() {
            const modal = document.getElementById('propertyDetailModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // ë§¤ë¬¼ ì •ë³´ HTML ë Œë”ë§ (ë°˜ì‘í˜• ê°œì„  ì ìš©)
        async function renderPropertyDetail(property) {
            const fields = property.fields;
            const address = fields['ì§€ë²ˆ ì£¼ì†Œ'] || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ';
            const recordId = property.id;
            
            // ì´ë¯¸ì§€ ì²˜ë¦¬
            let photoUrl = '/images/default-thumb.jpg';
            
            try {
                const response = await fetch(`/api/check-image?record_id=${recordId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.hasImage && data.filename) {
                        photoUrl = `/airtable_backup/images/${recordId}/${data.filename}`;
                    }
                }
            } catch (error) {
                console.log('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©');
            }
            
            // ê°€ê²© í˜•ì‹í™”
            let priceDisplay = 'ê°€ê²© ì •ë³´ ì—†ìŒ';
            if (fields['ë§¤ê°€(ë§Œì›)']) {
                const price = parseFloat(fields['ë§¤ê°€(ë§Œì›)']);
                priceDisplay = price >= 10000 ? 
                    `${(price / 10000).toFixed(1).replace('.0', '')}ì–µì›` : 
                    `${price.toLocaleString()}ë§Œì›`;
            }
            
            // HTML ìƒì„± (ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ ì ìš©)
            let html = `
            <div style="padding: 20px;">
                <h2 style="margin-bottom: 20px;">${address}</h2>
                
                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div style="background-image: url('${photoUrl}'); background-size: cover; background-position: center; height: 300px; border-radius: 8px;"></div>
                    
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 20px;">
                        <div class="property-details-responsive">
                            <div class="detail-row-responsive">
                                <div class="detail-label-responsive">ë§¤ê°€</div>
                                <div class="detail-value-responsive">${priceDisplay}</div>
                            </div>
            `;
            
            // í† ì§€ë©´ì 
            if (fields['í† ì§€ë©´ì (ã¡)']) {
                const sqm = parseFloat(fields['í† ì§€ë©´ì (ã¡)']);
                const pyeong = Math.round(sqm / 3.3058);
                html += `
                            <div class="detail-row-responsive">
                                <div class="detail-label-responsive">í† ì§€ë©´ì </div>
                                <div class="detail-value-responsive">${pyeong}í‰ (${sqm.toLocaleString()}ã¡)</div>
                            </div>
                `;
            }
            
            // ê±´ë¬¼ë©´ì 
            if (fields['ê±´ë¬¼ë©´ì (ã¡)']) {
                const sqm = parseFloat(fields['ê±´ë¬¼ë©´ì (ã¡)']);
                const pyeong = Math.round(sqm / 3.3058);
                html += `
                            <div class="detail-row-responsive">
                                <div class="detail-label-responsive">ê±´ë¬¼ë©´ì </div>
                                <div class="detail-value-responsive">${pyeong}í‰ (${sqm.toLocaleString()}ã¡)</div>
                            </div>
                `;
            }
            
            // ìˆ˜ìµë¥ 
            if (fields['ìœµìì œì™¸ìˆ˜ìµë¥ (%)']) {
                html += `
                            <div class="detail-row-responsive">
                                <div class="detail-label-responsive">ìˆ˜ìµë¥ </div>
                                <div class="detail-value-responsive">${fields['ìœµìì œì™¸ìˆ˜ìµë¥ (%)']}%</div>
                            </div>
                `;
            }
            
            // ê¸°íƒ€ ì •ë³´ë“¤
            if (fields['ì¸µìˆ˜']) {
                html += `
                            <div class="detail-row-responsive">
                                <div class="detail-label-responsive">ì¸µìˆ˜</div>
                                <div class="detail-value-responsive">${fields['ì¸µìˆ˜']}</div>
                            </div>
                `;
            }
            
            if (fields['ì£¼ìš©ë„']) {
                html += `
                            <div class="detail-row-responsive">
                                <div class="detail-label-responsive">ì£¼ìš©ë„</div>
                                <div class="detail-value-responsive">${fields['ì£¼ìš©ë„']}</div>
                            </div>
                `;
            }
            
            if (fields['ì¤€ê³µë…„ë„']) {
                html += `
                            <div class="detail-row-responsive">
                                <div class="detail-label-responsive">ì¤€ê³µë…„ë„</div>
                                <div class="detail-value-responsive">${fields['ì¤€ê³µë…„ë„']}</div>
                            </div>
                `;
            }
            
            // ë§ˆë¬´ë¦¬
            html += `
                        </div>
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button onclick="openConsultModal('${address}')" class="btn btn-contact" style="flex: 1;">ë¬¸ì˜í•˜ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
            `;
            
            return html;
        }

        // ì¡°ê±´ ê²€ìƒ‰ í¼ ì²˜ë¦¬
        document.addEventListener('DOMContentLoaded', function() {
            const mapSearchForm = document.getElementById('mapSearchForm');
            const resetButton = document.getElementById('resetSearch');
            const searchResults = document.getElementById('searchResults');
            const searchStatus = document.getElementById('searchStatus');
            const searchStatusText = document.getElementById('searchStatusText');
            const searchMapContainer = document.getElementById('searchMapContainer');
            
            console.log('ê²€ìƒ‰ í¼ ì´ˆê¸°í™”');
            
            if (!mapSearchForm) {
                console.error('ê²€ìƒ‰ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            // ê²€ìƒ‰ í¼ ì œì¶œ ì²˜ë¦¬
            mapSearchForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('ê²€ìƒ‰ í¼ ì œì¶œë¨');
                
                // ê²€ìƒ‰ ì¡°ê±´ ìˆ˜ì§‘
                const searchData = {
                    price_value: document.getElementById('priceValue').value,
                    price_condition: document.getElementById('priceCondition').value,
                    investment_value: document.getElementById('investmentValue').value,
                    investment_condition: document.getElementById('investmentCondition').value,
                    yield_value: document.getElementById('yieldValue').value,
                    yield_condition: document.getElementById('yieldCondition').value,
                    area_value: document.getElementById('areaValue').value,
                    area_condition: document.getElementById('areaCondition').value,
                    approval_date: document.getElementById('approvalDate').value,
                    approval_condition: document.getElementById('approvalCondition').value
                };
                
                console.log('ê²€ìƒ‰ ì¡°ê±´:', searchData);
                
                // ê²€ìƒ‰ ì‹œì‘ - ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
                searchResults.style.display = 'block';
                searchStatusText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì¡°ê±´ì— ë§ëŠ” ë§¤ë¬¼ì„ ê²€ìƒ‰ì¤‘ì…ë‹ˆë‹¤...';
                searchMapContainer.innerHTML = '<div class="loading-message" style="text-align: center; padding: 150px 20px;">ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
                
                try {
                    console.log('API í˜¸ì¶œ ì‹œì‘');
                    
                    const response = await fetch('/api/search-map', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(searchData)
                    });
                    
                    console.log('API ì‘ë‹µ ìƒíƒœ:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`ê²€ìƒ‰ ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('API ì‘ë‹µ ë°ì´í„°:', result);
                    
                    // ì§€ë„ ì—…ë°ì´íŠ¸
                    if (result.map_html) {
                        searchMapContainer.innerHTML = result.map_html;
                        
                        // ëª¨ë°”ì¼ ëŒ€ì‘ ì§€ë„ í¬ê¸° ì¡°ì •
                        setTimeout(() => {
                            if (window.innerWidth <= 768) {
                                searchMapContainer.style.height = '400px';
                                searchMapContainer.style.minHeight = '350px';
                                
                                const innerDivs = searchMapContainer.querySelectorAll('div[style*="width"]');
                                const iframes = searchMapContainer.querySelectorAll('iframe');
                                
                                innerDivs.forEach(div => {
                                    div.style.width = '100%';
                                    div.style.height = '100%';
                                });
                                
                                iframes.forEach(iframe => {
                                    iframe.style.width = '100%';
                                    iframe.style.height = '100%';
                                    iframe.style.position = 'absolute';
                                    iframe.style.top = '0';
                                    iframe.style.left = '0';
                                });
                            }
                        }, 100);
                    }
                    
                    // ê²€ìƒ‰ ì™„ë£Œ - ê²°ê³¼ í‘œì‹œ
                    searchStatusText.innerHTML = `ê²€ìƒ‰ ê²°ê³¼: <span id="resultCount">${result.count}</span>ê°œì˜ ë§¤ë¬¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`;
                    
                    // í†µê³„ ì •ë³´ í‘œì‹œ
                    if (result.statistics) {
                        const stats = result.statistics;
                        const existingStats = document.querySelector('.search-stats');
                        if (existingStats) {
                            existingStats.remove();
                        }
                        
                        const statsHtml = `
                            <div class="search-stats" style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 14px;">
                                <strong>ê²€ìƒ‰ í†µê³„:</strong><br>
                                - ì „ì²´ ë§¤ë¬¼: ${stats.total_records}ê°œ<br>
                                - ìƒíƒœ í•„í„°ë§: ${stats.status_filtered}ê°œ ì œì™¸<br>
                                - ì¡°ê±´ í•„í„°ë§: ${stats.condition_filtered}ê°œ ì œì™¸<br>
                                - í•„í„° í†µê³¼: ${stats.passed_filter}ê°œ<br>
                                - ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨: ${stats.geocoding_failed}ê°œ<br>
                                - ì§€ë„ì— í‘œì‹œ: ${stats.markers_added}ê°œ<br>
                                - ë°ì´í„° ì†ŒìŠ¤: ${stats.source === 'backup' ? 'ë°±ì—… ë°ì´í„°' : 'ì‹¤ì‹œê°„ ë°ì´í„°'}
                            </div>
                        `;
                        searchResults.insertAdjacentHTML('beforeend', statsHtml);
                    }
                    
                    // ê²€ìƒ‰ ê²°ê³¼ë¡œ ìŠ¤í¬ë¡¤
                    searchResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                } catch (error) {
                    console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                    
                    searchStatusText.innerHTML = '<i class="fas fa-exclamation-circle"></i> ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    searchMapContainer.innerHTML = `<div style="text-align: center; padding: 50px; color: red;">
                        ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>
                        ì—ëŸ¬: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}
                    </div>`;
                }
            });
            
            // ê²€ìƒ‰ ì´ˆê¸°í™”
            resetButton.addEventListener('click', function() {
                mapSearchForm.reset();
                searchResults.style.display = 'none';
                searchMapContainer.innerHTML = '';
                
                const existingStats = document.querySelector('.search-stats');
                if (existingStats) {
                    existingStats.remove();
                }
            });
        });

        // iframeê³¼ì˜ ë©”ì‹œì§€ í†µì‹  ì„¤ì •
        window.addEventListener('message', function(event) {
            // ì½˜ì†” ë©”ì„¸ì§€ ë¹„í™œì„±í™” 
            // console.log('ë©”ì‹œì§€ ìˆ˜ì‹ :', event.data);
            
            if (event.data && event.data.action === 'openPropertyDetail') {
                const recordId = event.data.recordId;
                // ì½˜ì†” ë©”ì„¸ì§€ ë¹„í™œì„±í™” 
                // console.log('iframeìœ¼ë¡œë¶€í„° ë§¤ë¬¼ ìƒì„¸ ìš”ì²­ ìˆ˜ì‹ :', recordId);
                openPropertyDetailModal(recordId);
            }
            
            if (event.data && event.data.action === 'openConsultModal') {
                const address = event.data.address;
                // ì½˜ì†” ë©”ì„¸ì§€ ë¹„í™œì„±í™” 
                // console.log('iframeìœ¼ë¡œë¶€í„° ìƒë‹´ ëª¨ë‹¬ ìš”ì²­ ìˆ˜ì‹ :', address);
                openConsultModal(address);
            }
        });

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const propertyModal = document.getElementById('propertyDetailModal');
                if (propertyModal && propertyModal.style.display === 'flex') {
                    closePropertyDetailModal();
                    return;
                }
                
                const consultModal = document.getElementById('consultModal');
                if (consultModal && consultModal.style.display === 'flex') {
                    closeConsultModal();
                    return;
                }
            }
        });

        // ì „ì—­ í•¨ìˆ˜ ë“±ë¡
        window.openPropertyDetailModal = openPropertyDetailModal;
        window.openPropertyDetail = openPropertyDetail;
        window.openPropertyDetail = window.openPropertyDetailModal;
        window.closePropertyDetailModal = closePropertyDetailModal;
        window.openConsultModal = openConsultModal;
        window.closeConsultModal = closeConsultModal;

        console.log('Search Property í†µí•© ìŠ¤í¬ë¦½íŠ¸ v5.0 ë¡œë“œ ì™„ë£Œ');
    </script>

    <!-- ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ ì¶”ê°€ -->
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ê°œì„  */
        .modal-background {
            z-index: 10000;
        }

        .modal-content {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ë§¤ë¬¼ ìƒì„¸ ì •ë³´ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
        .detail-row-responsive {
            display: block;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }

        .detail-label-responsive {
            display: block;
            font-weight: bold;
            color: #666;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .detail-value-responsive {
            display: block;
            color: #333;
            font-size: 16px;
        }

        /* íƒœë¸”ë¦¿ ì´ìƒì—ì„œë§Œ ê°€ë¡œ ë°°ì¹˜ */
        @media (min-width: 600px) {
            .detail-row-responsive {
                display: flex;
                align-items: center;
                margin-bottom: 12px;
            }
            
            .detail-label-responsive {
                flex: 0 0 25%;
                margin-bottom: 0;
                margin-right: 15px;
            }
            
            .detail-value-responsive {
                flex: 1;
            }
        }

        /* ëª¨ë°”ì¼ ëª¨ë‹¬ ê°œì„  */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-width: none;
            }
        }
    </style>
</body>
</html>